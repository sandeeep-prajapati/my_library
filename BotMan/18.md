
---

### 🧠 Step-by-Step: Referral System with Botman and Laravel

---

#### **1. Database Design**

Create a `referrals` table to track codes and usage.

```bash
php artisan make:migration create_referrals_table
```

```php
Schema::create('referrals', function (Blueprint $table) {
    $table->id();
    $table->unsignedBigInteger('user_id'); // original referrer
    $table->string('referral_code')->unique();
    $table->unsignedBigInteger('referred_user_id')->nullable(); // person who used the code
    $table->timestamps();
});
```

---

#### **2. Generate Referral Code**

Add logic to generate a referral code after an order or interaction:

```php
use Illuminate\Support\Str;

$referralCode = strtoupper(Str::random(8));
Referral::create([
    'user_id' => $userId,
    'referral_code' => $referralCode,
]);
```

Send it via the bot:

```php
$botman->say("Thanks for ordering! Here's your referral code: *{$referralCode}*.\nShare it and earn ₹50 off when someone uses it!", $userId);
```

---

#### **3. Accept Referral Code at Order Time**

In the conversation flow, ask:

> “Do you have a referral code?”

If yes, accept and validate:

```php
$code = strtoupper(trim($referralInput));
$referral = Referral::where('referral_code', $code)->whereNull('referred_user_id')->first();

if ($referral) {
    $referral->update(['referred_user_id' => $newUserId]);

    // Apply reward
    // e.g., ₹50 off or store for future order
}
```

---

#### **4. Reward Logic**

* Add `referral_discount` field in orders table.
* Apply discount when referral is used.
* Notify referrer when reward is unlocked:

```php
$botman->say("🎉 Your friend used your code! You've earned ₹50 off your next order.", $referral->user_id);
```

---

#### **5. Track Referral Usage**

In admin panel, show:

* Total codes generated
* Who used them
* Rewards pending/used

---

### ✅ Optional Features

* Only allow 1 referral use per new user.
* Set expiry for codes (7 days).
* QR code of referral link via Laravel package.

---
