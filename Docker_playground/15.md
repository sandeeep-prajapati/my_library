
```yaml
version: '3.8'

# Define secrets to be loaded from external files
secrets:
  django_secret_key:
    file: ./secrets/django_secret_key.txt
  postgres_password:
    file: ./secrets/postgres_password.txt
  redis_password:
    file: ./secrets/redis_password.txt

# Define named volumes for persistent data
volumes:
  postgres_data:
    name: ${COMPOSE_PROJECT_NAME:-app}_postgres_data
  redis_data:
    name: ${COMPOSE_PROJECT_NAME:-app}_redis_data
  static_volume:
    name: ${COMPOSE_PROJECT_NAME:-app}_static_volume
  media_volume:
    name: ${COMPOSE_PROJECT_NAME:-app}_media_volume

# Define networks for service isolation
networks:
  frontend:
    name: ${COMPOSE_PROJECT_NAME:-app}_frontend
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16
  backend:
    name: ${COMPOSE_PROJECT_NAME:-app}_backend
    driver: bridge
    ipam:
      config:
        - subnet: 172.21.0.0/16

services:
  # PostgreSQL Database
  postgres:
    image: postgres:15-alpine
    container_name: ${COMPOSE_PROJECT_NAME:-app}_postgres
    restart: unless-stopped
    secrets:
      - postgres_password
    environment:
      POSTGRES_DB: ${POSTGRES_DB:-appdb}
      POSTGRES_USER: ${POSTGRES_USER:-appuser}
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
      POSTGRES_INITDB_ARGS: "--encoding=UTF-8 --locale=C"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./postgres/init:/docker-entrypoint-initdb.d:ro
    networks:
      - backend
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U ${POSTGRES_USER:-appuser}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 30s
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Redis for caching and Celery broker
  redis:
    image: redis:7-alpine
    container_name: ${COMPOSE_PROJECT_NAME:-app}_redis
    restart: unless-stopped
    command: redis-server --requirepass /run/secrets/redis_password
    secrets:
      - redis_password
    volumes:
      - redis_data:/data
      - ./redis/redis.conf:/usr/local/etc/redis/redis.conf:ro
    networks:
      - backend
    healthcheck:
      test: ["CMD", "redis-cli", "--raw", "incr", "ping"]
      interval: 10s
      timeout: 3s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "3"

  # Django Application
  django:
    build:
      context: ./backend
      dockerfile: Dockerfile
      args:
        PYTHON_VERSION: 3.11
    container_name: ${COMPOSE_PROJECT_NAME:-app}_django
    restart: unless-stopped
    secrets:
      - django_secret_key
      - postgres_password
      - redis_password
    environment:
      # Django settings
      DJANGO_SETTINGS_MODULE: config.settings.production
      DJANGO_SECRET_KEY_FILE: /run/secrets/django_secret_key
      DJANGO_DEBUG: "false"
      DJANGO_ALLOWED_HOSTS: ${DJANGO_ALLOWED_HOSTS:-localhost,127.0.0.1}
      DJANGO_CSRF_TRUSTED_ORIGINS: ${DJANGO_CSRF_TRUSTED_ORIGINS:-http://localhost:3000}
      
      # Database
      POSTGRES_DB: ${POSTGRES_DB:-appdb}
      POSTGRES_USER: ${POSTGRES_USER:-appuser}
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
      POSTGRES_HOST: postgres
      POSTGRES_PORT: 5432
      
      # Redis
      REDIS_HOST: redis
      REDIS_PORT: 6379
      REDIS_PASSWORD_FILE: /run/secrets/redis_password
      
      # Celery
      CELERY_BROKER_URL: redis://:$$(cat $$REDIS_PASSWORD_FILE)@redis:6379/0
      CELERY_RESULT_BACKEND: redis://:$$(cat $$REDIS_PASSWORD_FILE)@redis:6379/1
    volumes:
      - static_volume:/app/staticfiles
      - media_volume:/app/media
      - ./backend:/app:ro
    networks:
      - backend
      - frontend
    depends_on:
      postgres:
        condition: service_healthy
      redis:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:8000/health/"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    deploy:
      resources:
        limits:
          memory: 2G
          cpus: '2.0'
        reservations:
          memory: 1G
          cpus: '1.0'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
        tag: "django"

  # Celery Worker
  celery_worker:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: ${COMPOSE_PROJECT_NAME:-app}_celery_worker
    restart: unless-stopped
    command: celery -A config.celery_app worker --loglevel=info --concurrency=4
    secrets:
      - django_secret_key
      - postgres_password
      - redis_password
    environment:
      DJANGO_SETTINGS_MODULE: config.settings.production
      DJANGO_SECRET_KEY_FILE: /run/secrets/django_secret_key
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
      REDIS_PASSWORD_FILE: /run/secrets/redis_password
      CELERY_BROKER_URL: redis://:$$(cat $$REDIS_PASSWORD_FILE)@redis:6379/0
      CELERY_RESULT_BACKEND: redis://:$$(cat $$REDIS_PASSWORD_FILE)@redis:6379/1
    volumes:
      - ./backend:/app:ro
    networks:
      - backend
    depends_on:
      django:
        condition: service_started
      redis:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'
      replicas: 2
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        tag: "celery_worker"

  # Celery Beat Scheduler
  celery_beat:
    build:
      context: ./backend
      dockerfile: Dockerfile
    container_name: ${COMPOSE_PROJECT_NAME:-app}_celery_beat
    restart: unless-stopped
    command: celery -A config.celery_app beat --loglevel=info
    secrets:
      - django_secret_key
      - postgres_password
      - redis_password
    environment:
      DJANGO_SETTINGS_MODULE: config.settings.production
      DJANGO_SECRET_KEY_FILE: /run/secrets/django_secret_key
      POSTGRES_PASSWORD_FILE: /run/secrets/postgres_password
      REDIS_PASSWORD_FILE: /run/secrets/redis_password
      CELERY_BROKER_URL: redis://:$$(cat $$REDIS_PASSWORD_FILE)@redis:6379/0
    volumes:
      - ./backend:/app:ro
      - ./celery_beat:/tmp/celery_beat
    networks:
      - backend
    depends_on:
      django:
        condition: service_started
      redis:
        condition: service_healthy
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        tag: "celery_beat"

  # React Frontend
  react:
    build:
      context: ./frontend
      dockerfile: Dockerfile
      args:
        NODE_ENV: production
    container_name: ${COMPOSE_PROJECT_NAME:-app}_react
    restart: unless-stopped
    ports:
      - "${FRONTEND_PORT:-3000}:3000"
    environment:
      NODE_ENV: production
      REACT_APP_API_URL: ${REACT_APP_API_URL:-http://localhost:8000}
      REACT_APP_WS_URL: ${REACT_APP_WS_URL:-ws://localhost:8000}
    volumes:
      - ./frontend:/app:ro
      - /app/node_modules
      - /app/build
    networks:
      - frontend
    depends_on:
      django:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3000"]
      interval: 30s
      timeout: 5s
      retries: 3
      start_period: 40s
    deploy:
      resources:
        limits:
          memory: 1G
          cpus: '1.0'
        reservations:
          memory: 512M
          cpus: '0.5'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        tag: "react"

  # NGINX Reverse Proxy (optional but recommended for production)
  nginx:
    image: nginx:1.23-alpine
    container_name: ${COMPOSE_PROJECT_NAME:-app}_nginx
    restart: unless-stopped
    ports:
      - "${HTTP_PORT:-80}:80"
      - "${HTTPS_PORT:-443}:443"
    volumes:
      - ./nginx/nginx.conf:/etc/nginx/nginx.conf:ro
      - ./nginx/conf.d:/etc/nginx/conf.d:ro
      - static_volume:/static:ro
      - media_volume:/media:ro
      - ./nginx/ssl:/etc/nginx/ssl:ro
    networks:
      - frontend
    depends_on:
      django:
        condition: service_healthy
      react:
        condition: service_healthy
    healthcheck:
      test: ["CMD", "nginx", "-t"]
      interval: 30s
      timeout: 10s
      retries: 3
    deploy:
      resources:
        limits:
          memory: 512M
          cpus: '0.5'
        reservations:
          memory: 256M
          cpus: '0.25'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "5"
        tag: "nginx"
```

## Required supporting files:

### 1. **`.env` file** (environment variables):
```env
COMPOSE_PROJECT_NAME=myapp
POSTGRES_DB=appdb
POSTGRES_USER=appuser
DJANGO_ALLOWED_HOSTS=localhost,127.0.0.1,example.com
DJANGO_CSRF_TRUSTED_ORIGINS=https://example.com,http://localhost:3000
FRONTEND_PORT=3000
HTTP_PORT=80
HTTPS_PORT=443
REACT_APP_API_URL=http://localhost:8000/api
```

### 2. **Secrets directory structure**:
```
secrets/
├── django_secret_key.txt
├── postgres_password.txt
└── redis_password.txt
```

Generate strong secrets:
```bash
# Generate Django secret key
openssl rand -hex 64 > secrets/django_secret_key.txt

# Generate PostgreSQL password
openssl rand -hex 32 > secrets/postgres_password.txt

# Generate Redis password
openssl rand -hex 32 > secrets/redis_password.txt

# Set proper permissions
chmod 600 secrets/*.txt
chmod 700 secrets/
```

### 3. **Django Dockerfile** (`backend/Dockerfile`):
```dockerfile
FROM python:3.11-slim

# Install system dependencies
RUN apt-get update && apt-get install -y \
    gcc \
    postgresql-client \
    && rm -rf /var/lib/apt/lists/*

# Set working directory
WORKDIR /app

# Install Python dependencies
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

# Copy application code
COPY . .

# Create non-root user
RUN useradd -m -u 1000 appuser && chown -R appuser:appuser /app
USER appuser

# Run application
CMD ["gunicorn", "--bind", "0.0.0.0:8000", "--workers", "3", "config.wsgi:application"]
```

### 4. **React Dockerfile** (`frontend/Dockerfile`):
```dockerfile
FROM node:18-alpine as build

WORKDIR /app

# Copy package files
COPY package*.json ./

# Install dependencies
RUN npm ci --only=production

# Copy source code
COPY . .

# Build the application
RUN npm run build

# Production stage
FROM nginx:1.23-alpine

# Copy built assets from build stage
COPY --from=build /app/build /usr/share/nginx/html

# Copy nginx configuration
COPY nginx.conf /etc/nginx/conf.d/default.conf

EXPOSE 3000

CMD ["nginx", "-g", "daemon off;"]
```

### 5. **Basic nginx configuration** (`nginx/nginx.conf`):
```nginx
events {
    worker_connections 1024;
}

http {
    upstream django {
        server django:8000;
    }

    upstream react {
        server react:3000;
    }

    server {
        listen 80;
        server_name localhost;

        # React frontend
        location / {
            proxy_pass http://react;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Django API
        location /api/ {
            proxy_pass http://django;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        # Django admin and static files
        location /admin/ {
            proxy_pass http://django;
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
        }

        location /static/ {
            alias /static/;
            expires 1y;
            add_header Cache-Control "public, immutable";
        }

        location /media/ {
            alias /media/;
            expires 1d;
            add_header Cache-Control "public";
        }

        # Health check endpoint
        location /health {
            access_log off;
            return 200 "healthy\n";
            add_header Content-Type text/plain;
        }
    }
}
```

## Key Production Features:

1. **Secrets Management**: All sensitive data is stored in external files, not in the compose file or environment
2. **Resource Limits**: CPU and memory limits prevent any single service from consuming all resources
3. **Health Checks**: Each service has appropriate health checks for proper orchestration
4. **Network Isolation**: Frontend and backend services are separated for security
5. **Persistent Storage**: Named volumes ensure data survives container restarts
6. **Logging**: JSON logging with rotation prevents disk space issues
7. **Restart Policies**: `unless-stopped` ensures services automatically restart on failure
8. **Graceful Dependencies**: `condition: service_healthy` ensures services wait for dependencies to be ready

## Usage:

```bash
# Set up secrets first
mkdir -p secrets
# Add your secret files as described above

# Create necessary directories
mkdir -p postgres/init nginx/ssl celery_beat

# Start the application
docker-compose up -d

# View logs
docker-compose logs -f

# Scale celery workers
docker-compose up -d --scale celery_worker=4

# Stop the application
docker-compose down -v
```
