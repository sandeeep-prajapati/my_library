Here’s a clean way to implement a **Laravel Artisan command `py:serve`** that auto-runs a Python server (e.g., Flask) in the background and allows Laravel to communicate with it via API.

We’ll handle:

* Running Flask in a virtual environment (`.venv`)
* Background execution so Laravel doesn’t block
* Logging server output
* Gracefully stopping the server

---

## ✅ Step 1: Create the Command

```bash
php artisan make:command PyServeCommand
```

---

## Step 2: Update Command File

**File:** `app/Console/Commands/PyServeCommand.php`

```php
<?php

namespace App\Console\Commands;

use Illuminate\Console\Command;
use Symfony\Component\Process\Process;
use App\Services\PythonLoggerService;

class PyServeCommand extends Command
{
    protected $signature = 'py:serve {--host=127.0.0.1} {--port=5000} {--detach : Run in background}';
    protected $description = 'Start a Python Flask server in the background and connect via API';

    public function handle()
    {
        $venvPath = base_path('.venv');
        $host = $this->option('host');
        $port = $this->option('port');
        $detach = $this->option('detach');

        // Flask app entry point
        $flaskApp = base_path('python_server/app.py'); // adjust path

        if (!file_exists($flaskApp)) {
            $this->error("Flask app not found at {$flaskApp}");
            return 1;
        }

        $pythonPath = $venvPath . '/bin/python';
        if (strtoupper(substr(PHP_OS, 0, 3)) === 'WIN') {
            $pythonPath = $venvPath . '\\Scripts\\python.exe';
        }

        if (!file_exists($pythonPath)) {
            $this->error('Python not found in virtual environment. Run `php artisan py:init` first.');
            return 1;
        }

        // Command to run Flask
        $cmd = [$pythonPath, $flaskApp, '--host', $host, '--port', $port];

        if ($detach) {
            // Run in background
            $process = new Process($cmd);
            $process->setTimeout(null);
            $process->start();
            $this->info("Flask server started in background at http://{$host}:{$port}");
        } else {
            // Run in foreground
            $process = new Process($cmd);
            $process->setTty(true);
            $process->setTimeout(null);
            $this->info("Starting Flask server at http://{$host}:{$port} ...");
            $process->run(function ($type, $buffer) {
                echo $buffer;
            });
        }

        PythonLoggerService::log(
            action: 'serve',
            status: 'info',
            message: "Flask server started on http://{$host}:{$port}"
        );

        return 0;
    }
}
```

---

## ✅ Step 3: Sample Flask App (`python_server/app.py`)

```python
from flask import Flask, jsonify, request

app = Flask(__name__)

@app.route("/api/hello")
def hello():
    return jsonify({"message": "Hello from Python!"})

@app.route("/api/add", methods=['POST'])
def add():
    data = request.get_json()
    a = data.get('a', 0)
    b = data.get('b', 0)
    return jsonify({"result": a + b})

if __name__ == "__main__":
    import sys
    host = sys.argv[sys.argv.index("--host") + 1] if "--host" in sys.argv else "127.0.0.1"
    port = int(sys.argv[sys.argv.index("--port") + 1]) if "--port" in sys.argv else 5000
    app.run(host=host, port=port)
```

---

## ✅ Step 4: Run the Server

### Foreground (logs in CLI)

```bash
php artisan py:serve
```

### Background (detached)

```bash
php artisan py:serve --detach
```

Output:

```
Flask server started in background at http://127.0.0.1:5000
```

---

## ✅ Step 5: Connect from Laravel

You can call the Python API using Laravel’s `Http` client:

```php
use Illuminate\Support\Facades\Http;

$response = Http::get('http://127.0.0.1:5000/api/hello');
$data = $response->json();
dd($data); // ["message" => "Hello from Python!"]
```

---

## ✅ Step 6: Optional Enhancements

1. **Auto-restart server on failure**
2. **Specify virtual environment path in `.env`**
3. **Add stop/restart commands**: e.g., `py:serve-stop` using PID file
4. **Log all requests/responses** in `storage/logs/py-package.log`
5. **Use Supervisor or systemd** for production Flask server

---

If you want, I can create **`py:serve-stop` and `py:serve-status` commands** too, so you can fully manage the Python background server from Laravel like a proper package manager.
