Here's a complete implementation to create a **Laravel scheduled command** that syncs new products with a Python embedding server, including error handling, batch processing, and progress tracking:

---

### **1. Create the Artisan Command**

```bash
php artisan make:command SyncEmbeddings
```

### **2. Implement the Command Logic (`app/Console/Commands/SyncEmbeddings.php`)**

```php
<?php

namespace App\Console\Commands;

use Illuminate\Console\Command;
use Illuminate\Support\Facades\Http;
use App\Models\Product;
use Illuminate\Support\Facades\Log;
use Illuminate\Support\Facades\DB;

class SyncEmbeddings extends Command
{
    protected $signature = 'sync:embeddings 
                            {--batch-size=100 : Number of products to process per batch}
                            {--force : Process all products regardless of sync status}';
    
    protected $description = 'Sync product embeddings with Python ML service';

    public function handle()
    {
        $batchSize = (int)$this->option('batch-size');
        $force = $this->option('force');

        $query = Product::query()
            ->whereNull('embedding_synced_at')
            ->orWhere(function($query) use ($force) {
                if ($force) {
                    $query->whereNotNull('embedding_synced_at');
                }
            });

        $totalProducts = $query->count();
        $processed = 0;

        $this->info("Starting sync for {$totalProducts} products...");

        $query->chunkById($batchSize, function ($products) use (&$processed, $totalProducts) {
            try {
                DB::beginTransaction();

                $payload = $products->map(function ($product) {
                    return [
                        'product_id' => $product->id,
                        'name' => $product->name,
                        'description' => $product->description,
                        'image_url' => $product->getFirstMediaUrl('main'),
                    ];
                })->toArray();

                // Send to Python service
                $response = Http::timeout(60)
                    ->retry(3, 1000)
                    ->post(config('services.ml.embedding_url'), [
                        'items' => $payload
                    ]);

                if ($response->successful()) {
                    $embeddings = $response->json()['embeddings'];

                    foreach ($products as $index => $product) {
                        $product->update([
                            'embedding' => $embeddings[$index],
                            'embedding_synced_at' => now()
                        ]);
                    }

                    $processed += $products->count();
                    $this->info("Processed {$processed}/{$totalProducts} products");
                    DB::commit();
                } else {
                    DB::rollBack();
                    Log::error("ML Service Error: " . $response->body());
                    $this->error("Failed batch: " . $response->body());
                }

            } catch (\Exception $e) {
                DB::rollBack();
                Log::error("Sync failed: " . $e->getMessage());
                $this->error("Error: " . $e->getMessage());
            }
        });

        $this->info("Completed! Processed {$processed} products");
        return Command::SUCCESS;
    }
}
```

---

### **3. Configure the Scheduler (`app/Console/Kernel.php`)**

```php
protected function schedule(Schedule $schedule)
{
    $schedule->command('sync:embeddings --batch-size=50')
        ->hourly()
        ->onOneServer()
        ->withoutOverlapping()
        ->appendOutputTo(storage_path('logs/embedding_sync.log'));
}
```

---

### **4. Python FastAPI Endpoint (Example)**

```python
# ml_service/main.py
from fastapi import FastAPI, HTTPException
import numpy as np
from pydantic import BaseModel
from typing import List
import your_embedding_model  # Your actual ML model

app = FastAPI()

class ProductRequest(BaseModel):
    product_id: int
    name: str
    description: str
    image_url: str

@app.post("/generate-embeddings")
async def generate_embeddings(items: List[ProductRequest]):
    try:
        # Process batch and generate embeddings
        embeddings = []
        for item in items:
            # Generate embedding from text + image (example)
            text_embedding = your_embedding_model.embed_text(f"{item.name} {item.description}")
            img_embedding = your_embedding_model.embed_image(item.image_url)
            combined = np.concatenate([text_embedding, img_embedding]).tolist()
            embeddings.append(combined)
        
        return {"embeddings": embeddings}
    
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))
```

---

### **5. Required Configurations**

#### **Add to `.env`**
```ini
ML_EMBEDDING_URL=http://python-ml-service:8000/generate-embeddings
```

#### **Add to `config/services.php`**
```php
'ml' => [
    'embedding_url' => env('ML_EMBEDDING_URL'),
],
```

---

### **6. Database Migration for Tracking**

```bash
php artisan make:migration add_embedding_fields_to_products_table
```

```php
// Migration file
public function up()
{
    Schema::table('products', function (Blueprint $table) {
        $table->json('embedding')->nullable();
        $table->timestamp('embedding_synced_at')->nullable();
        $table->index('embedding_synced_at');  // For faster querying
    });
}
```

---

### **7. Error Handling & Monitoring**

#### **Create a Notification Channel**
```bash
php artisan make:notification EmbeddingSyncFailed
```

```php
// In the Command's catch block
Notification::route('slack', config('logging.slack_webhook'))
    ->notify(new EmbeddingSyncFailed($e->getMessage()));
```

#### **Set Up Horizon (For Queue Monitoring)**
```php
// config/horizon.php
'environments' => [
    'production' => [
        'sync-embeddings' => [
            'connection' => 'redis',
            'queue' => ['embeddings'],
            'balance' => 'auto',
            'processes' => 5,
            'tries' => 3,
        ]
    ]
]
```

---

### **Key Features**

1. **Batch Processing**: Handles large catalogs efficiently
2. **Resilient Retries**: 3 attempts with 1-second delay
3. **Transaction Safety**: Rolls back on failures
4. **Progress Tracking**: Real-time console output
5. **Scheduler Ready**: Prevents overlapping runs
6. **Multi-Modal Embeddings**: Combines text + image data

---

### **Usage Examples**

```bash
# Normal sync (only unsynced products)
php artisan sync:embeddings

# Force re-sync all products
php artisan sync:embeddings --force

# Custom batch size
php artisan sync:embeddings --batch-size=200
```

---

### **Performance Tips**

1. **Parallel Processing**: 
   ```php
   $schedule->command('sync:embeddings')->everyFiveMinutes()->runInBackground();
   ```

2. **Redis Cache**:
   Cache product data to avoid DB hits:
   ```php
   $product->load(['media', 'categories']);
   ```

3. **GPU Acceleration**:
   Configure your Python service to use:
   ```python
   torch.set_num_threads(4)  # Optimal for most CPUs
   ```
