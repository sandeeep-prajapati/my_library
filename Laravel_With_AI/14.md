Here's a complete implementation to sync your Laravel product catalog with Qdrant, including queue jobs, embedding generation, and batch processing:

---

### **1. Create Migration for Sync Tracking**
```bash
php artisan make:migration add_embedding_fields_to_products_table
```

```php
Schema::table('products', function (Blueprint $table) {
    $table->json('embedding')->nullable()->comment('Vector embedding');
    $table->timestamp('last_embedded_at')->nullable();
    $table->boolean('needs_embedding')->default(true)->index();
});
```

---

### **2. Generate Job for Embedding Sync**
```bash
php artisan make:job SyncProductEmbedding
```

```php
<?php

namespace App\Jobs;

use App\Models\Product;
use Illuminate\Bus\Batchable;
use Illuminate\Bus\Queueable;
use Illuminate\Contracts\Queue\ShouldQueue;
use Illuminate\Foundation\Bus\Dispatchable;
use Illuminate\Queue\InteractsWithQueue;
use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Log;

class SyncProductEmbedding implements ShouldQueue
{
    use Batchable, Dispatchable, InteractsWithQueue, Queueable;

    public function __construct(public Product $product) {}

    public function handle()
    {
        // Skip if job is part of a failed batch
        if ($this->batch()?->cancelled()) {
            return;
        }

        try {
            // Get embedding from ML service
            $response = Http::timeout(120)
                ->retry(3, 1000)
                ->post(config('services.ml.embedding_url'), [
                    'text' => $this->product->title,
                    'image_url' => $this->product->getFirstMediaUrl('main')
                ]);

            if ($response->successful()) {
                $embedding = $response->json()['embedding'];

                // Update Qdrant
                Http::withHeaders(['Content-Type' => 'application/json'])
                    ->put(config('services.qdrant.url').'/collections/products/points', [
                        'points' => [
                            [
                                'id' => $this->product->id,
                                'vector' => $embedding,
                                'payload' => $this->buildPayload()
                            ]
                        ]
                    ]);

                // Mark as synced in local DB
                $this->product->update([
                    'embedding' => $embedding,
                    'last_embedded_at' => now(),
                    'needs_embedding' => false
                ]);
            } else {
                Log::error("Embedding failed for product {$this->product->id}", [
                    'status' => $response->status(),
                    'error' => $response->body()
                ]);
            }
        } catch (\Exception $e) {
            Log::error("Sync failed for product {$this->product->id}: ".$e->getMessage());
            throw $e;
        }
    }

    protected function buildPayload(): array
    {
        return [
            'product_id' => $this->product->sku,
            'title' => $this->product->title,
            'description' => $this->product->description,
            'category' => $this->product->category->name,
            'price' => $this->product->price,
            'in_stock' => $this->product->stock > 0,
            'created_at' => $this->product->created_at->toIso8601String(),
            'metadata' => [
                'color' => $this->product->color,
                'size' => $this->product->size_options
            ]
        ];
    }
}
```

---

### **3. Create Batch Sync Command**
```bash
php artisan make:command SyncProductEmbeddings
```

```php
<?php

namespace App\Console\Commands;

use App\Models\Product;
use Illuminate\Console\Command;
use Illuminate\Support\Facades\Bus;

class SyncProductEmbeddings extends Command
{
    protected $signature = 'products:sync-embeddings 
                            {--all : Process all products}
                            {--chunk=100 : Batch size}';

    protected $description = 'Sync product embeddings to Qdrant';

    public function handle()
    {
        $query = Product::query();
        
        if (!$this->option('all')) {
            $query->where('needs_embedding', true);
        }

        $count = $query->count();
        $this->info("Syncing {$count} products...");

        $query->chunkById($this->option('chunk'), function ($products) {
            $jobs = $products->map(fn ($product) => 
                new SyncProductEmbedding($product)
            );

            Bus::batch($jobs)
                ->name('product-embeddings-sync')
                ->allowFailures()
                ->dispatch();
        });

        $this->info("Dispatched {$count} sync jobs");
    }
}
```

---

### **4. Configure Services**
#### **config/services.php**
```php
'qdrant' => [
    'url' => env('QDRANT_URL', 'http://localhost:6333'),
    'collection' => env('QDRANT_COLLECTION', 'products')
],

'ml' => [
    'embedding_url' => env('ML_EMBEDDING_URL')
],
```

#### **.env**
```ini
QDRANT_URL=http://your-qdrant-instance:6333
ML_EMBEDDING_URL=http://your-fastapi-service:8000/embed
```

---

### **5. Initialize Qdrant Collection**
Create a console command to set up the collection:

```bash
php artisan make:command InitQdrantCollection
```

```php
<?php

namespace App\Console\Commands;

use Illuminate\Console\Command;
use Qdrant\Config;
use Qdrant\Http\GuzzleClient;
use Qdrant\Models\Request\CreateCollection;
use Qdrant\Models\Request\VectorParams;

class InitQdrantCollection extends Command
{
    protected $signature = 'qdrant:init';
    protected $description = 'Initialize Qdrant collection';

    public function handle()
    {
        $client = new \Qdrant\QdrantClient(new Config(config('services.qdrant.url')));

        try {
            $client->collections()->create(
                config('services.qdrant.collection'),
                (new CreateCollection())
                    ->addVector(new VectorParams(512, VectorParams::DISTANCE_COSINE))
                    ->setPayloadSchema([
                        'title' => 'text',
                        'category' => 'keyword',
                        'price' => 'float',
                        'in_stock' => 'bool'
                    ])
            );

            $this->info('Collection created successfully');
        } catch (\Exception $e) {
            $this->error('Failed: ' . $e->getMessage());
        }
    }
}
```

---

### **6. Schedule Regular Syncs**
Add to `app/Console/Kernel.php`:

```php
protected function schedule(Schedule $schedule)
{
    $schedule->command('products:sync-embeddings')
        ->hourly()
        ->withoutOverlapping()
        ->appendOutputTo(storage_path('logs/embedding_sync.log'));
}
```

---

### **7. Model Observer for Real-time Updates**
```bash
php artisan make:observer ProductObserver -m Product
```

```php
<?php

namespace App\Observers;

use App\Models\Product;
use App\Jobs\SyncProductEmbedding;

class ProductObserver
{
    public function saved(Product $product)
    {
        if ($product->isDirty(['title', 'description', 'price', 'stock'])) {
            $product->update(['needs_embedding' => true]);
            SyncProductEmbedding::dispatch($product)
                ->onQueue('embeddings');
        }
    }

    public function deleted(Product $product)
    {
        Http::delete(config('services.qdrant.url')."/collections/products/points/{$product->id}");
    }
}
```

Register in `AppServiceProvider`:
```php
public function boot()
{
    Product::observe(ProductObserver::class);
}
```

---

### **8. Queue Configuration**
#### **config/queue.php**
```php
'connections' => [
    'embeddings' => [
        'driver' => 'redis',
        'connection' => 'default',
        'queue' => 'embeddings',
        'retry_after' => 180,
        'block_for' => null,
    ],
],
```

#### **Supervisor Config**
```ini
[program:laravel-embeddings-worker]
process_name=%(program_name)s_%(process_num)02d
command=php /var/www/artisan queue:work redis --queue=embeddings --sleep=3 --tries=3
autostart=true
autorestart=true
user=www-data
numprocs=4
redirect_stderr=true
stdout_logfile=/var/www/storage/logs/worker.log
```

---

### **Key Features**
1. **Efficient Batching**: Processes products in chunks
2. **Resilient Retries**: Automatic retry for failed jobs
3. **Real-time Sync**: Model observer triggers updates
4. **Payload Optimization**: Structured metadata for filtering
5. **Scalable Queues**: Dedicated queue for embedding jobs

---

### **Deployment Flow**
1. Initialize collection:
   ```bash
   php artisan qdrant:init
   ```

2. First full sync:
   ```bash
   php artisan products:sync-embeddings --all
   ```

3. Monitor queue:
   ```bash
   php artisan queue:monitor embeddings
   ```

This implementation provides a **production-ready** pipeline for keeping your product catalog in sync with vector embeddings, with proper error handling and scalability.