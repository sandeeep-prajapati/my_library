
---

### **1. Laravel Setup**

#### **Routes (`routes/web.php`)**
```php
use App\Http\Controllers\ImageController;

Route::post('/upload-image', [ImageController::class, 'upload'])->name('upload.image');
```

#### **Controller (`app/Http/Controllers/ImageController.php`)**
```php
<?php

namespace App\Http\Controllers;

use Illuminate\Http\Request;
use Illuminate\Support\Facades\Http;
use Illuminate\Support\Facades\Log;

class ImageController extends Controller
{
    public function upload(Request $request)
    {
        // Validate the uploaded file
        $request->validate([
            'image' => 'required|image|mimes:jpeg,png,jpg|max:2048',
        ]);

        try {
            // Get the image file
            $image = $request->file('image');
            $imagePath = $image->getPathname();

            // Send to Python FastAPI backend
            $response = Http::attach(
                'image', 
                file_get_contents($imagePath),
                $image->getClientOriginalName()
            )->post('http://python-server:8000/generate-embedding');

            // Handle response
            if ($response->successful()) {
                $embedding = $response->json()['embedding'];
                return response()->json([
                    'success' => true,
                    'embedding' => $embedding,
                    'message' => 'Embedding generated successfully'
                ]);
            } else {
                Log::error("Python API error: " . $response->body());
                return response()->json([
                    'success' => false,
                    'message' => 'Failed to generate embedding'
                ], 500);
            }

        } catch (\Exception $e) {
            Log::error("Error processing image: " . $e->getMessage());
            return response()->json([
                'success' => false,
                'message' => 'Server error'
            ], 500);
        }
    }
}
```

---

### **2. Python FastAPI Backend**

#### **FastAPI Server (`main.py`)**
```python
from fastapi import FastAPI, UploadFile, File, HTTPException
from fastapi.middleware.cors import CORSMiddleware
import numpy as np
from PIL import Image
import torch
import torchvision.models as models
from torchvision import transforms
import io

app = FastAPI()

# CORS Configuration
app.add_middleware(
    CORSMiddleware,
    allow_origins=["*"],
    allow_methods=["POST"],
)

# Load pre-trained model (ResNet50 example)
model = models.resnet50(pretrained=True)
model = torch.nn.Sequential(*(list(model.children())[:-1]))  # Remove last layer
model.eval()

# Preprocessing transform
transform = transforms.Compose([
    transforms.Resize(256),
    transforms.CenterCrop(224),
    transforms.ToTensor(),
    transforms.Normalize(mean=[0.485, 0.456, 0.406], std=[0.229, 0.224, 0.225]),
])

@app.post("/generate-embedding")
async def generate_embedding(image: UploadFile = File(...)):
    try:
        # Read image file
        contents = await image.read()
        img = Image.open(io.BytesIO(contents)).convert("RGB")
        
        # Preprocess and get embedding
        img_tensor = transform(img).unsqueeze(0)
        with torch.no_grad():
            embedding = model(img_tensor).squeeze().numpy().tolist()
        
        return {"embedding": embedding}
    
    except Exception as e:
        raise HTTPException(status_code=500, detail=str(e))
```

---

### **3. Docker Setup (Optional)**

#### **docker-compose.yml**
```yaml
version: '3.8'

services:
  laravel:
    build:
      context: .
      dockerfile: Dockerfile.laravel
    ports:
      - "8000:8000"
    volumes:
      - .:/var/www/html
    depends_on:
      - python-server

  python-server:
    image: python:3.9
    working_dir: /app
    volumes:
      - ./python-api:/app
    ports:
      - "8001:8000"
    command: uvicorn main:app --host 0.0.0.0 --port 8000
```

---

### **4. Key Components**

1. **Laravel Side**:
   - Uses `Illuminate\Http\Client` for HTTP requests
   - Validates image uploads (JPEG/PNG, <2MB)
   - Logs errors for debugging
   - Returns JSON response with embedding or error

2. **Python Side**:
   - FastAPI endpoint accepts multipart file upload
   - Uses PyTorch to generate embeddings (2048-d for ResNet50)
   - Handles CORS for cross-origin requests

3. **Error Handling**:
   - Laravel logs errors to storage/logs
   - FastAPI returns 500 on processing failures

---

### **5. Testing the Flow**

1. **Upload via cURL**:
```bash
curl -X POST http://laravel.test/upload-image \
  -H "Content-Type: multipart/form-data" \
  -F "image=@test.jpg"
```

2. **Expected Response**:
```json
{
  "success": true,
  "embedding": [0.12, -0.34, ..., 0.87],
  "message": "Embedding generated successfully"
}
```

---

### **6. Performance Optimizations**

1. **Laravel**:
   - Queue image processing for async handling
   - Cache embeddings if images are reused

2. **Python**:
   - Use ONNX runtime for faster inference
   - Add batch processing endpoint

3. **Deployment**:
   - Scale Python workers with Gunicorn:
     ```Dockerfile
     command: gunicorn -w 4 -k uvicorn.workers.UvicornWorker main:app
     ```

---
