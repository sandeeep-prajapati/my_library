Below is a **complete Go testing crash course** covering:

âœ” Unit tests
âœ” Table-driven tests
âœ” Mocks / stubs / interfaces
âœ” Testing HTTP handlers
âœ” Testing goroutines and channels
âœ” Using `testify` (optional but useful)

Everything is in *copy-paste runnable* snippets.

---

# âœ… 1. Basics of Go Testing (`testing` package)

## File structure

Go automatically runs all files ending with `_test.go`.

```
math/
 â”œâ”€â”€ math.go
 â””â”€â”€ math_test.go
```

---

# ğŸ“Œ Example 1 â€” Simple Unit Test

### `math.go`

```go
package mathutil

func Add(a, b int) int {
	return a + b
}
```

### `math_test.go`

```go
package mathutil

import "testing"

func TestAdd(t *testing.T) {
	got := Add(2, 3)
	want := 5

	if got != want {
		t.Errorf("Add(2,3) = %d; want %d", got, want)
	}
}
```

### Run tests

```
go test
```

---

# ğŸ“Œ Example 2 â€” Table-Driven Tests (MOST COMMON pattern in Go)

### `math.go`

```go
func Multiply(a, b int) int {
	return a * b
}
```

### `math_test.go`

```go
func TestMultiply(t *testing.T) {
	tests := []struct {
		name     string
		a, b     int
		expected int
	}{
		{"positive", 3, 4, 12},
		{"zero", 5, 0, 0},
		{"negative", -2, 8, -16},
	}

	for _, tt := range tests {
		t.Run(tt.name, func(t *testing.T) {
			got := Multiply(tt.a, tt.b)
			if got != tt.expected {
				t.Fatalf("Multiply(%d,%d) got %d; expected %d",
					tt.a, tt.b, got, tt.expected)
			}
		})
	}
}
```

âœ” Uses `t.Run()`
âœ” Each test case is isolated
âœ” Clean and scalable

---

# ğŸ“Œ Example 3 â€” Testing Errors

### `divide.go`

```go
package mathutil

import "errors"

func Divide(a, b int) (int, error) {
	if b == 0 {
		return 0, errors.New("divide by zero")
	}
	return a / b, nil
}
```

### `divide_test.go`

```go
func TestDivide(t *testing.T) {
	_, err := Divide(10, 0)
	if err == nil {
		t.Fatal("expected error, got nil")
	}
}
```

---

# ğŸš€ 2. Mocks in Go (with interfaces)

Go doesnâ€™t have a â€œmockâ€ system like Java/Python.
We **mock via interfaces + test implementations**.

---

# ğŸ“Œ Example 4 â€” Interface + Mock for Testing

### `emailer.go`

```go
package notify

type EmailSender interface {
	SendEmail(to, msg string) error
}

type Notifier struct {
	Email EmailSender
}

func (n *Notifier) SendWelcome(to string) error {
	return n.Email.SendEmail(to, "Welcome!")
}
```

### Mock Implementation (`emailer_test.go`)

```go
package notify

import (
	"errors"
	"testing"
)

type MockEmailSender struct {
	SentTo string
	Msg    string
	Err    error
}

func (m *MockEmailSender) SendEmail(to, msg string) error {
	m.SentTo = to
	m.Msg = msg
	return m.Err
}

func TestNotifier_SendWelcome(t *testing.T) {
	mock := &MockEmailSender{}
	n := &Notifier{Email: mock}

	err := n.SendWelcome("test@example.com")
	if err != nil {
		t.Fatal(err)
	}

	if mock.SentTo != "test@example.com" {
		t.Errorf("expected email to %s, got %s", "test@example.com", mock.SentTo)
	}

	if mock.Msg != "Welcome!" {
		t.Errorf("expected message Welcome!, got %s", mock.Msg)
	}
}
```

âœ” Mock stores values so we can assert
âœ” No external services involved

---

# ğŸ“Œ Example 5 â€” Mocking Errors

```go
func TestNotifier_Fails(t *testing.T) {
	mock := &MockEmailSender{Err: errors.New("smtp down")}
	n := &Notifier{Email: mock}

	err := n.SendWelcome("x@y.com")
	if err == nil {
		t.Fatal("expected error")
	}
}
```

---

# ğŸ“Œ Example 6 â€” Testing HTTP Handlers (Super Important)

### `handler.go`

```go
package api

import (
	"encoding/json"
	"net/http"
)

type User struct {
	Name string `json:"name"`
}

func HelloHandler(w http.ResponseWriter, r *http.Request) {
	json.NewEncoder(w).Encode(User{Name: "Sandeep"})
}
```

### `handler_test.go`

```go
package api

import (
	"encoding/json"
	"net/http"
	"net/http/httptest"
	"testing"
)

func TestHelloHandler(t *testing.T) {
	req := httptest.NewRequest("GET", "/hello", nil)
	rr := httptest.NewRecorder()

	HelloHandler(rr, req)

	if rr.Code != http.StatusOK {
		t.Fatalf("status code = %d, want %d", rr.Code, 200)
	}

	var u User
	json.NewDecoder(rr.Body).Decode(&u)

	if u.Name != "Sandeep" {
		t.Fatalf("expected \"Sandeep\", got %q", u.Name)
	}
}
```

âœ” Uses `httptest.NewRecorder()` to capture response
âœ” No server needed

---

# ğŸ“Œ Example 7 â€” Testing Goroutines and Channels

### `worker.go`

```go
package worker

func SumAsync(a, b int, out chan int) {
	go func() {
		out <- (a + b)
	}()
}
```

### `worker_test.go`

```go
package worker

import "testing"

func TestSumAsync(t *testing.T) {
	ch := make(chan int)
	SumAsync(2, 3, ch)

	result := <-ch
	if result != 5 {
		t.Fatalf("expected 5, got %d", result)
	}
}
```

---

# ğŸ“Œ Example 8 â€” Testing with Timeout (avoid goroutine leaks)

```go
func TestSumAsyncTimeout(t *testing.T) {
	ch := make(chan int)
	SumAsync(2, 3, ch)

	select {
	case v := <-ch:
		if v != 5 {
			t.Fatalf("expected 5, got %d", v)
		}
	case <-time.After(1 * time.Second):
		t.Fatal("test timed out (goroutine stuck?)")
	}
}
```

---

# ğŸ“Œ Example 9 â€” Using Testify (optional but common)

Install:

```
go get github.com/stretchr/testify/assert
```

### Test using `assert`

```go
import "github.com/stretchr/testify/assert"

func TestAdd(t *testing.T) {
	assert.Equal(t, 5, Add(2, 3))
}
```

### With mocks (using `testify/mock`)

```go
type EmailMock struct {
	mock.Mock
}

func (m *EmailMock) SendEmail(to, msg string) error {
	args := m.Called(to, msg)
	return args.Error(0)
}

func TestNotifier(t *testing.T) {
	mockEmail := new(EmailMock)
	mockEmail.On("SendEmail", "hello@example.com", "Welcome!").Return(nil)

	n := Notifier{Email: mockEmail}
	n.SendWelcome("hello@example.com")

	mockEmail.AssertExpectations(t)
}
```

---

# ğŸ“˜ Summary

| Topic                   | Covered |
| ----------------------- | ------- |
| Unit Tests              | âœ”       |
| Table Tests             | âœ”       |
| Error Testing           | âœ”       |
| Interface-based Mocks   | âœ”       |
| HTTP Handler Testing    | âœ”       |
| Goroutines & Channels   | âœ”       |
| Timeouts & Race Issues  | âœ”       |
| Testify (assert & mock) | âœ”       |

---

# Want next?

I can also teach:

âœ… How to write **benchmarks** (`go test -bench`)
âœ… How to write **fuzz tests** (Go 1.18+)
âœ… How to test **database code** with mocks (sqlmock)
âœ… How to test **gRPC servers**, **REST APIs**, or **WebSockets**
Just tell me!
